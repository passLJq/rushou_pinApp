<html>
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
    <title>个人中心</title>
    <link rel="stylesheet" type="text/css" href="./common/css/api.css"/>
  </head>
  <style>
  .weui_cells {
  margin-top: 1.17647059em;
  background-color: #fff;
  line-height: 1.41176471;
  font-size: 17px;
  overflow: hidden;
  position: relative;
}
.shopCenterCentent, .up_pic, .comboContentList, .transferCenter {
    margin-top: 0;
    font-size: 15px;
}
.pd15 {
    padding: 15px;
}
.weui_cell {
    padding: 10px 15px;
    position: relative;
    display: -webkit-box;
    display: -webkit-flex;
    display: flex;
    -webkit-box-align: center;
    -webkit-align-items: center;
    align-items: center;
  }
    .weui_label {
    display: block;
    width: 105px;
    word-wrap: break-word;
    word-break: break-all;
}
.color3 {
    color: #333;
}
.weui_cell_primary {
    -webkit-box-flex: 1;
    -webkit-flex: 1;
    flex: 1;
}
div{
  margin: 0;
padding: 0;
border: 0;
font-size: 100%;
font: inherit;
}
.weui_cell_primary {
    -webkit-box-flex: 1;
    -webkit-flex: 1;
    flex: 1;
}
input[type=button], input[type=submit], input[type=file], input[type=text], button {
    cursor: pointer;
    -webkit-appearance: none;
}
.changeGoods {
    overflow: hidden;
    text-overflow: ellipsis;
    display: -webkit-box;
    -webkit-box-orient: vertical;
    -webkit-line-clamp: 2;
}
.weui_input {
    width: 100%;
    border: 0;
    outline: 0;
    -webkit-appearance: none;
    background-color: transparent;
    font-size: inherit;
    color: inherit;
    height: 1.41176471em;
    line-height: 1.41176471;
}
.button_sp_area {
    padding: 10px 0;
    width: 60%;
    margin: 0 auto;
    text-align: justify;
    text-justify: distribute-all-lines;
    font-size: 0;
}
.shopCenterButton {
    padding-top: 50px;
}
.button_sp_area {
    padding: 10px 0;
    width: 60%;
    margin: 0 auto;
    text-align: justify;
    text-justify: distribute-all-lines;
    font-size: 0;
}
.upDatePic {
    width: 70%;
    margin: 15px auto;
    padding: 0 20px;
    height: 175px;
    border: 1px dashed #999;
    border-radius: 5px;
    background: #fff;
    display: flex;
align-items: center;
justify-content: center;
overflow: hidden;
}
.u_foot{text-align: center;margin-top: 30px}
.btnn{display: inline-block;
      padding: 6px 12px;
      margin-bottom: 0;
      font-size: 14px;
      font-weight: 400;
      line-height: 1.42857143;
      text-align: center;
      white-space: nowrap;
      vertical-align: middle;
      -ms-touch-action: manipulation;
      touch-action: manipulation;
      cursor: pointer;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
      background-image: none;
      border: 1px solid transparent;
      border-radius: 4px;
      color: #fff;
      background-color: #5bc0de;
      border-color: #46b8da;
      width: 30%}
      .abox{
        overflow: auto;
        text-align: center;
        width: 90%;
      }
  </style>
  <body>
    <!-- <div id="head"></div> -->
    <div class="weui_cells shopCenterCentent">
        <div class="weui_cell pd15">
                <div class="weui_cell_hd"><label class="weui_label color3">申请服务</label></div>
                <div class="weui_cell_bd weui_cell_primary">
                    <input class="weui_input" type="text" value="部分商品换货" disabled="disabled">
                </div>
        </div>
        <div class="weui_cell pd15" id='shopname'>
        </div>

        <div class="weui_cell pd15" id="buycount">
        </div>
        <div class="weui_cell pd15">
                <div class="weui_cell_hd"><label class="weui_label color3">换货原因</label></div>
                <div class="weui_cell_bd weui_cell_primary">
                    <input id="txtDesc" name="txtDesc" class="weui_input" tabindex="2" type="text" value="" placeholder="换货原因">
                    <input type="hidden" name="hidProId" id="hidProId" value="170906153301948920">
                    <input type="hidden" name="hidPackageId" id="hidPackageId" value="170914113105102055">
                </div>
        </div>
        <div class="pd15 up_pic weui_cells">
            <div class="weui_cell_hd"><label class="weui_label color3">上传图片</label></div>
            <div class="upDatePic">
                <div class="weui-media-box__bd  btn-new  upDatePicList upDatePicList3 abox" onclick="a()">
                    <img src="./image/upPhoto.png" id="uploadImg" style="margin: 0 auto;width: 70%;">
                </div>
            </div>
        </div>
    </div>
        <div class="u_foot">
          <a class="btnn" id="full" onclick="subb(phon)">提交</a>
        </div>



    <script type="text/javascript" src="./common/js/api.js"></script>
    <script type="text/javascript" src="./common/js/config.js"></script>
    <script type="text/javascript" src="./common/js/common.js"></script>
    <script>
      if (openapp) {
        window.apiready = function () {
          isready()
        }
      } else {
        window.onload = function () {
          isready()
        }
      }
    var isready = function(){
    //   headTitle(document.getElementById('head'),'换货');
      $api.html($api.byId('buycount'),'<div class="weui_cell_hd"><label class="weui_label color3">换货数量</label></div><div class="weui_cell_bd weui_cell_primary"><input id="txtNum" name="txtNum" class="weui_input" tabindex="3" type="number" value='+pageParam('buycount')+' maxlength="10"  placeholder="换货数量"></div>');
      $api.html($api.byId('shopname'),'<div class="weui_cell_hd"><label class="weui_label color3">换货商品</label></div><div class="weui_cell_bd weui_cell_primary"><input class="weui_input changeGoods" type="text" id="txtPro" name="txtPro" readonly="true" value='+pageParam('proname')+'></div>');
    }
  var phon='';
      function a(){
            api.getPicture({
            sourceType: 'library',
            mediaValue: 'pic',
            destinationType: 'base64',
            allowEdit: true,
            targetWidth: 1080,
            saveToPhotoAlbum: false
        }, function(ret, err) {
          if (ret) {
            api.showProgress({
              title: '上传图片中...',
              text: '先喝杯茶...',
              modal: true
          });
              $api.attr($api.byId('uploadImg'), 'src',ret.data);
              api.ajax({
                    url: memberSiteUrl+'/Ajax/FileUpload.ashx',
                    method: 'post',
                    data: {
                        files: {
                            file: ret.data
                        }
                    }
                }, function(ret, err) {
                  api.hideProgress();
                  if(api.systemType=="ios"){
                    var iosdata = JSON.parse(err.body.replace(/'/g,'"'));
                    if(iosdata.success){
                        promptMsg("上传成功")
                        phon=iosdata.fullurl
                    }else{
                        promptMsg(err.msg)
                    }
                  }else{
                    if (ret) {
                        if(ret.success){
                          promptMsg("上传成功")
                          phon=ret.fullurl;
                        }
                    } else {
                      promptMsg(err.msg)
                    }
                  }
                });
              } else {
                api.hideProgress();
                    alert("上传失败");
                }
          });
      }
      function subb(phon){
        var desc=$api.val($api.byId('txtDesc'));
        var buycount_num=parseInt($api.val($api.byId('txtNum')));
        var buycount_numm=parseInt(pageParam('buycount'));
        var uploadImg=$api.attr($api.byId('uploadImg'),'src')
        if(desc==''){
            promptMsg('换货原因不能为空');
            return false;
        }if(buycount_num==''||buycount_num>buycount_numm){
          promptMsg('请填写正确的数量');
          return false;
        }
        if(uploadImg==""||uploadImg=='./image/upPhoto.png'){
          promptMsg('图片不能为空');
          return false;
        }
        api.ajax({
            url: siteUrl+'Main/Member/ExchangeOrder?uid='+api.getPrefs({sync: true,key: 'SessionUserID'}),
            method: 'post',
            data: {
                body: {
                    orderid:pageParam('orderid'),
                    itemid:pageParam('itemid'),
                    proid:pageParam('proid'),
                    packageid:pageParam('packageid'),
                    uid:api.getPrefs({sync: true,key: 'SessionUserID'}),
                    img:phon,
                    desc:desc
                }
            },
            headers:{
              "Authorization": api.getPrefs({sync: true,key: 'SessionKey'}),
              "Content-Type": 'application/json; charset=utf-8'
            }
        }, function(ret, err) {
            if (ret) {
              if(ret.success){
                promptMsg('修改成功');
                setTimeout(function() {
                    api.closeWin({
                        name: 'exchangedatail'
                    })
                }, 1000)
                api.sendEvent({
                    name: 'orderdetail_bindData',
                    extra: {}
                });
              }else {
                alert(ret.err)
              }
            } else {
                api.alert({ msg: JSON.stringify(err) });
            }
        });
      }

    </script>
  </body>
  </html>
